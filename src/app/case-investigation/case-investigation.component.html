<div class="case-investigation-container">
  <div class="header">
    <div class="header-content">
      <div>
        <h1>Case Submission</h1>
        <p class="subtitle">Review and submit your case for investigation</p>
      </div>
      <div class="case-id" *ngIf="caseId">
        <span class="case-id-label">Case ID:</span>
        <span class="case-id-value">{{ caseId }}</span>
      </div>
    </div>
  </div>

  <div *ngIf="!reportData" class="error-container">
    <p class="error-message">No report data found. Please go back and fill out the form again.</p>
    <button class="back-button" routerLink="/fraud-investigation-intake">Return to Form</button>
  </div>

  <div *ngIf="reportData" class="report-summary">
    <div class="section">
      <h2>Contact Information</h2>
      <div class="info-row">
        <div class="info-label">Full Name:</div>
        <div class="info-value">{{ reportData.fullName }}</div>
      </div>
      <div class="info-row">
        <div class="info-label">Email:</div>
        <div class="info-value">{{ reportData.email }}</div>
      </div>
    </div>

    <div class="section collapsible-section">
      <div class="section-header" (click)="toggleIncidentSection()">
        <h2>Incident Information</h2>
        <div class="toggle-icon">{{ isIncidentSectionExpanded ? '‚ñº' : '‚ñ∂' }}</div>
      </div>
      
      <div class="section-content" [ngClass]="{'collapsed': !isIncidentSectionExpanded}">
        <div class="subsection">
          <h3>Incident Details</h3>
          <div class="info-row">
            <div class="info-label">Your Wallet Address(es):</div>
            <div class="info-value">{{ reportData.victimWallet }}</div>
          </div>
          <div class="info-row" *ngIf="reportData.scammerWallet">
            <div class="info-label">Scammer Wallet Address(es):</div>
            <div class="info-value">{{ reportData.scammerWallet }}</div>
          </div>
          <div class="info-row" *ngIf="reportData.exchangePlatform">
            <div class="info-label">Exchange or Platform:</div>
            <div class="info-value">{{ reportData.exchangePlatform }}</div>
          </div>
          <div class="info-row" *ngIf="reportData.tokenName">
            <div class="info-label">Coin(s) / Token(s):</div>
            <div class="info-value">{{ reportData.tokenName }}</div>
          </div>
          <div class="info-row">
            <div class="info-label">Amount Lost (USD):</div>
            <div class="info-value">${{ reportData.amountLost.toFixed(2) }}</div>
          </div>
        </div>

        <div class="subsection">
          <h3>Incident Description</h3>
          <div class="description-box">
            <p>{{ reportData.incidentDescription }}</p>
          </div>
        </div>

        <div class="subsection" *ngIf="reportData.evidenceUrls">
          <h3>Evidence URLs</h3>
          <div class="description-box">
            <p class="evidence-url" *ngFor="let url of reportData.evidenceUrls.split('\n')">
              <a [href]="url" target="_blank" rel="noopener noreferrer">{{ url }}</a>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Case Comments Panel -->
    <div class="section collapsible-section">
      <div class="section-header" (click)="toggleCommentsSection()">
        <h2>Case Comments</h2>
        <div class="toggle-icon">{{ isCommentsExpanded ? '‚ñº' : '‚ñ∂' }}</div>
      </div>
      
      <div class="section-content" [ngClass]="{'collapsed': !isCommentsExpanded}">
        <!-- Add new comment form -->
        <div class="add-comment-form">
          <div class="form-group">
            <label for="newComment">Add a Comment</label>
            <textarea 
              id="newComment" 
              [(ngModel)]="newComment" 
              rows="3" 
              placeholder="Enter your comment here..."
              [disabled]="isAddingComment"
            ></textarea>
          </div>
          
          <div class="form-group">
            <label for="commentStatus">Status</label>
            <select id="commentStatus" [(ngModel)]="commentStatus" [disabled]="isAddingComment">
              <option value="submitted">Submitted</option>
              <option value="under-review">Under Review</option>
              <option value="investigating">Investigating</option>
              <option value="escalated">Escalated</option>
              <option value="closed">Closed</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Attach Files</label>
            <div class="file-upload-container">
              <input 
                type="file" 
                id="fileUpload" 
                multiple 
                (change)="onFileSelected($event)" 
                accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.xls,.xlsx,.txt"
                [disabled]="isAddingComment"
              >
              <label for="fileUpload" class="file-upload-button" [class.disabled]="isAddingComment">Choose Files</label>
              <span class="file-name" *ngIf="selectedFiles.length > 0">{{ selectedFiles.length }} file(s) selected</span>
            </div>
            <div class="upload-hint">Accepted formats: JPG, PNG, PDF, DOC, XLSX, TXT (max 10MB each)</div>
            <div class="error-message" *ngIf="fileUploadError">{{ fileUploadError }}</div>
          </div>
          
          <div class="error-message" *ngIf="commentError">{{ commentError }}</div>
          
          <button 
            class="add-comment-button" 
            (click)="addComment()" 
            [disabled]="isAddingComment || !newComment.trim()"
          >
            <span *ngIf="!isAddingComment">Add Comment</span>
            <span *ngIf="isAddingComment" class="loading-spinner">Adding...</span>
          </button>
        </div>
        
        <!-- Comments table -->
        <div class="comments-table-container">
          <h3>Comments History</h3>
          <table class="comments-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Comment</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let comment of caseComments">
                <td>{{ formatDate(comment.timestamp) }}</td>
                <td class="comment-cell">
                  <div *ngIf="!isMarkdownReport(comment.comment) && !isAssessmentRow(comment)">
                    <div markdown [data]="comment.comment"></div>
                  </div>
                  <div *ngIf="isMarkdownReport(comment.comment) && !isAssessmentRow(comment)" class="report-link">
                    <a (click)="openMarkdownModal(comment)" class="markdown-link">
                      <span *ngIf="comment.updatedBy === 'Automatic Assessment System'">View Automatic Case Assessment</span>
                      <span *ngIf="comment.updatedBy === 'Blockchain Forensics Bot'">View Blockchain Forensics Report</span>
                      <span *ngIf="comment.updatedBy !== 'Automatic Assessment System' && comment.updatedBy !== 'Blockchain Forensics Bot'">View Detailed Report</span>
                    </a>
                  </div>
                  <div *ngIf="isAssessmentRow(comment)" class="assessment-summary">
                    <p class="assessment-message">Initial assessment has been completed. Please see the reports we generated based on your case:</p>
                    <div class="assessment-links">
                      <ng-container *ngIf="comment.reportLinks && comment.reportLinks.length > 0">
                        <a *ngFor="let link of comment.reportLinks" (click)="openReportByType(link.reportType)" class="assessment-link">
                          <i class="assessment-icon">{{ link.icon }}</i> {{ link.title }}
                        </a>
                      </ng-container>
                      <ng-container *ngIf="!comment.reportLinks || comment.reportLinks.length === 0">
                        <!-- Fallback if no links are provided -->
                        <a (click)="openAssessmentReport()" class="assessment-link">
                          <i class="assessment-icon">üìä</i> Automatic Case Assessment
                        </a>
                        <a (click)="openForensicsReport()" class="assessment-link">
                          <i class="assessment-icon">üîç</i> Blockchain Forensics Report
                        </a>
                      </ng-container>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="status-badge" [ngClass]="getStatusClass(comment.status)">
                    {{ comment.status | titlecase }}
                  </span>
                </td>
              </tr>
              <tr *ngIf="caseComments.length === 0">
                <td colspan="3" class="no-comments">No comments yet. Add your first comment above.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <div class="action-section">
      <div *ngIf="!success">
        <div class="error-message" *ngIf="error">{{ error }}</div>
        <button 
          class="submit-button" 
          (click)="submitForInvestigation()" 
          [disabled]="isSubmitting"
        >
          <span *ngIf="!isSubmitting">Submit a Case</span>
          <span *ngIf="isSubmitting" class="loading-spinner">Submitting...</span>
        </button>
        <button class="back-button" routerLink="/fraud-investigation-intake" [disabled]="isSubmitting">
          Back to Edit
        </button>
      </div>

      <div *ngIf="success" class="success-container">
        <div class="success-message">
          <h3>Case Submitted Successfully!</h3>
          <p>Your case has been submitted for investigation. Your case ID is: <strong>{{ caseId }}</strong></p>
          <p>Please save this ID for future reference. We will contact you via email with updates.</p>
        </div>
        <button class="home-button" routerLink="/">Return to Home</button>
      </div>
    </div>
  </div>
</div>

<!-- Markdown Modal -->
<div class="markdown-modal" *ngIf="showMarkdownModal" (click)="closeMarkdownModal($event)">
  <div class="markdown-modal-content" (click)="$event.stopPropagation()">
    <div class="markdown-modal-header">
      <h2>{{ selectedComment?.updatedBy }} Report</h2>
      <button class="close-button" (click)="closeMarkdownModal($event)">&times;</button>
    </div>
    <div class="markdown-modal-body">
      <div markdown [data]="selectedComment?.comment"></div>
    </div>
    <div class="markdown-modal-footer">
      <button class="close-modal-button" (click)="closeMarkdownModal($event)">Close</button>
    </div>
  </div>
</div>
